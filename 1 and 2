//Create class StoreSystem
//Import file employee.csv & outlet.csv
//Manager-> User ID: C6001,Password: a2b1c0

//Login/Logout and Employee Registration
//Attendance Log

import java.io.File;
import java.io.FileWriter;
import java.io.IOException;
import java.io.PrintWriter;

import java.time.Duration;
import java.time.LocalDate;
import java.time.LocalTime;
import java.time.format.DateTimeFormatter;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Scanner;

//Employee
class Employee {
    private String id;
    private String name;
    private String role;
    private String password;
    private String outlet;

    public Employee(String id, String name, String role, String password, String outlet) {
        this.id = id;
        this.name = name;
        this.role = role;
        this.password = password;
        this.outlet = outlet;
    }

    public String getId() { return id; }
    public String getName() { return name; }
    public String getRole() { return role; }
    public String getPassword() { return password; }
    public String getOutlet() { return outlet; }
}

//Attendance
class Attendance {
    private String employeeId;
    private LocalDate date;
    private LocalTime clockIn;
    private LocalTime clockOut;
    private String outlet;

    public Attendance(String employeeId, LocalDate date, LocalTime clockIn, LocalTime clockOut, String outlet) {
        this.employeeId = employeeId;
        this.date = date;
        this.clockIn = clockIn;
        this.clockOut = clockOut;
        this.outlet = outlet;
    }

    public String getEmployeeId() { return employeeId; }
    public LocalDate getDate() { return date; }
    public LocalTime getClockIn() { return clockIn; }
    public LocalTime getClockOut() { return clockOut; }
    public String getOutlet() { return outlet; }

    public void setClockOut(LocalTime time) {
        this.clockOut = time;
    }

    public String toCSV() {
        return employeeId + "," + date + "," + clockIn + "," +
               (clockOut == null ? "null" : clockOut) + "," + outlet;
    }
}

//Main System
public class StoreSystem {

    private static final String EMPLOYEE_FILE = "employee.csv";
    private static final String OUTLET_FILE = "outlet.csv";
    private static final String ATTENDANCE_FILE = "attendance.csv";

    private static List<Employee> employees = new ArrayList<>();
    private static List<Attendance> attendanceLogs = new ArrayList<>();
    private static Map<String, String> outletMap = new HashMap<>();

    private static Scanner sc = new Scanner(System.in);
    private static Employee currentUser = null;

    //Main
    public static void main(String[] args) {
        loadData();
        System.out.println("Loaded employees: " + employees.size());

        while (true) {
            if (currentUser == null) {
                loginMenu();
            } else {
                mainMenu();
            }
        }
    }

    //Login
    private static void loginMenu() {
        System.out.println("\n=== GOLDENHOUR STORE SYSTEM ===");
        System.out.println("1. Login");
        System.out.println("2. Exit");
        System.out.print("Select: ");
        String choice = sc.nextLine();

        if (choice.equals("1")) login();
        else if (choice.equals("2")) System.exit(0);
        else System.out.println("Invalid option.");
    }

    private static void login() {
        System.out.println("\n=== Employee Login ===");
        System.out.print("Enter User ID: ");
        String id = sc.nextLine().trim();
        System.out.print("Enter Password: ");
        String pass = sc.nextLine().trim();

        for (Employee e : employees) {
            if (e.getId().equalsIgnoreCase(id)
                    && e.getPassword().equals(pass)) {

                currentUser = e;
                String code = id.substring(0, 3);
                System.out.println("\nLogin Successful!");
                System.out.println("Welcome, " + e.getName() + " (" + code + ")");
                return;
            }
        }
        System.out.println("Login Failed: Invalid User ID or Password.");
    }

    private static void logout() {
        currentUser = null;
        System.out.println("Logged out successfully.");
    }

    //Menu
    private static void mainMenu() {
        System.out.println("\n=== Main Menu (" + currentUser.getName() + ") ===");
        System.out.println("1. Clock In");
        System.out.println("2. Clock Out");

        if (currentUser.getRole().equalsIgnoreCase("Manager")) {
            System.out.println("3. Register New Employee");
        }

        System.out.println("4. Logout");
        System.out.print("Select: ");
        String choice = sc.nextLine();

        switch (choice) {
            case "1": clockIn(); break;
            case "2": clockOut(); break;
            case "3":
                if (currentUser.getRole().equalsIgnoreCase("Manager"))
                    registerEmployee();
                else
                    System.out.println("Unauthorized.");
                break;
            case "4": logout(); break;
            default: System.out.println("Invalid option.");
        }
    }

    //Register
    private static void registerEmployee() {
        System.out.println("\n=== Register New Employee ===");
        System.out.print("Enter Employee Name: ");
        String name = sc.nextLine();

        String id;
        String outlet;

        while (true) {
            System.out.print("Enter Employee ID (e.g. C6013): ");
            id = sc.nextLine().trim();

            boolean exists = false;
            for (Employee e : employees) {
                if (e.getId().equalsIgnoreCase(id)) exists = true;
            }
            if (exists) {
                System.out.println("Employee ID already exists.");
                continue;
            }

            String code = id.substring(0, 3);
            if (outletMap.containsKey(code)) {
                outlet = code + " (" + outletMap.get(code) + ")";
                break;
            } else {
                System.out.println("Invalid outlet code.");
            }
        }

        System.out.print("Set Role (Part-time/Full-time): ");
        String role = sc.nextLine();
        System.out.print("Set Password: ");
        String pass = sc.nextLine();

        employees.add(new Employee(id, name, role, pass, outlet));
        saveEmployees();

        System.out.println("Employee successfully registered!");
        System.out.println("Assigned to: " + outlet);
    }

    //Attendance
    private static void clockIn() {
        LocalDate today = LocalDate.now();

        for (Attendance a : attendanceLogs) {
            if (a.getEmployeeId().equals(currentUser.getId())
                    && a.getDate().equals(today)
                    && a.getClockOut() == null) {
                System.out.println("You are already clocked in.");
                return;
            }
        }

        Attendance log = new Attendance(
                currentUser.getId(),
                today,
                LocalTime.now(),
                null,
                currentUser.getOutlet()
        );

        attendanceLogs.add(log);
        saveAttendance();

        System.out.println("\nClock In Successful!");
        displayAttendance(log);
    }

    private static void clockOut() {
        LocalDate today = LocalDate.now();

        for (Attendance a : attendanceLogs) {
            if (a.getEmployeeId().equals(currentUser.getId())
                    && a.getDate().equals(today)
                    && a.getClockOut() == null) {

                a.setClockOut(LocalTime.now());
                saveAttendance();

                Duration d = Duration.between(a.getClockIn(), a.getClockOut());
                double hours = d.toMinutes() / 60.0;

                System.out.println("\nClock Out Successful!");
                displayAttendance(a);
                System.out.printf("Total Hours Worked: %.1f hours%n", hours);
                return;
            }
        }
        System.out.println("No active clock-in record found.");
    }

    private static void displayAttendance(Attendance a) {
        System.out.println("Employee ID: " + currentUser.getId());
        System.out.println("Name: " + currentUser.getName());
        System.out.println("Outlet: " + a.getOutlet());
        System.out.println("Date: " + a.getDate());
        System.out.println("Time: " + formatTime(
                a.getClockOut() == null ? a.getClockIn() : a.getClockOut()));
    }

    //File Handling
    private static void loadData() {
        try {
            //Load outlets
            Scanner oSc = new Scanner(new File(OUTLET_FILE));
            while (oSc.hasNextLine()) {
                String[] p = oSc.nextLine().split(",");
                outletMap.put(p[0].trim(), p[1].trim());
            }
            oSc.close();

            //Load employees
            Scanner eSc = new Scanner(new File(EMPLOYEE_FILE));
            while (eSc.hasNextLine()) {
                String[] p = eSc.nextLine().split(",");

                String id = p[0].trim();
                String name = p[1].trim();
                String role = p[2].trim();
                String pass = p[3].trim();

                String code = id.substring(0, 3);
                String outlet = code + " (" + outletMap.get(code) + ")";

                employees.add(new Employee(id, name, role, pass, outlet));
            }
            eSc.close();
        } catch (Exception e) {
            System.out.println("Error loading data.");
        }
    }

    private static void saveEmployees() {
        try (PrintWriter pw = new PrintWriter(new FileWriter(EMPLOYEE_FILE))) {
            for (Employee e : employees) {
                pw.println(
                    e.getId() + "," +
                    e.getName() + "," +
                    e.getRole() + "," +
                    e.getPassword()
                );
            }
        } catch (IOException e) {
            System.out.println("Error saving employees.");
        }
    }

    private static void saveAttendance() {
        try (PrintWriter printWriter = new PrintWriter(new FileWriter(ATTENDANCE_FILE))) {
            for (Attendance a : attendanceLogs) {
                printWriter.println(a.toCSV());
            }
        } catch (IOException e) {
            System.out.println("Error saving attendance.");
        }
    }

    private static String formatTime(LocalTime t) {
        return t.format(DateTimeFormatter.ofPattern("hh:mm a"))
                .toLowerCase()
                .replace("am", "a.m.")
                .replace("pm", "p.m.");
    }
}
